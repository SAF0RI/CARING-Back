# CARING-Back í”„ë¡œì íŠ¸ ì½”ë”© ê·œì¹™

## ğŸ”´ CRITICAL: ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬

### âŒ ì ˆëŒ€ ê¸ˆì§€
```python
# ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ!
async def endpoint():
    db = next(get_db())  # âŒ Connection leak ë°œìƒ!
    # ...
```

**ë¬¸ì œì :**
- `next(get_db())`ëŠ” generatorë¥¼ ì™„ì „íˆ ì†Œë¹„í•˜ì§€ ì•Šì•„ `finally` ë¸”ë¡ì˜ `db.close()`ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- ì„¸ì…˜ì´ connection poolì— ë°˜í™˜ë˜ì§€ ì•Šì•„ connection leak ë°œìƒ
- ì¥ì‹œê°„ ìš´ì˜ ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ê³ ê°ˆë¡œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ê°€ëŠ¥

### âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš© ë°©ë²•
```python
# ë°˜ë“œì‹œ Depends ì‚¬ìš©
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db

async def endpoint(db: Session = Depends(get_db)):
    # FastAPIê°€ ìë™ìœ¼ë¡œ ì„¸ì…˜ì„ ì •ë¦¬í•¨
    # ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ìë™ìœ¼ë¡œ db.close() í˜¸ì¶œë¨
    # ...
```

**ì´ìœ :**
- FastAPIì˜ `Depends`ëŠ” generatorë¥¼ ì™„ì „íˆ ì†Œë¹„í•˜ì—¬ `finally` ë¸”ë¡ ì‹¤í–‰ ë³´ì¥
- ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ìë™ìœ¼ë¡œ ì„¸ì…˜ ì •ë¦¬ ë° connection pool ë°˜í™˜
- FastAPI ê³µì‹ ê¶Œì¥ ë°©ì‹

### ğŸ“‹ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ì ìš©
- **ëª¨ë“  FastAPI ë¼ìš°í„° ì—”ë“œí¬ì¸íŠ¸**ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ ì‚¬ìš©í•  ë•ŒëŠ” ë°˜ë“œì‹œ `Depends(get_db)` ì‚¬ìš©
- ìƒˆ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ ì‹œ ì´ ê·œì¹™ ì¤€ìˆ˜ í•„ìˆ˜
- ë¦¬íŒ©í† ë§ ì‹œ ê¸°ì¡´ `next(get_db())` íŒ¨í„´ ë°œê²¬ ì‹œ ì¦‰ì‹œ ìˆ˜ì •

## ğŸ”´ CRITICAL: FastAPI ì˜ì¡´ì„± ì£¼ì… (Dependency Injection)

### âŒ ì ˆëŒ€ ê¸ˆì§€: ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”
```python
# ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ!
async def endpoint(db: Session = Depends(get_db)):
    auth_service = get_auth_service(db)  # âŒ ì˜ëª»ëœ ë°©ì‹!
    voice_service = get_voice_service(db)  # âŒ ì˜ëª»ëœ ë°©ì‹!
    # ...
```

**ë¬¸ì œì :**
- FastAPIì˜ ì˜ì¡´ì„± ì£¼ì… ì‹œìŠ¤í…œì„ ìš°íšŒí•˜ì—¬ ì‚¬ìš©
- í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€ (Mock ì£¼ì… ë¶ˆê°€)
- ì˜ì¡´ì„± ê´€ë¦¬ê°€ ëª…í™•í•˜ì§€ ì•ŠìŒ
- ì½”ë“œ ì¬ì‚¬ìš©ì„± ì €í•˜

### âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš© ë°©ë²•: ì˜ì¡´ì„± ì£¼ì… í™œìš©

#### ë°©ë²• 1: ì˜ì¡´ì„± í•¨ìˆ˜ë¡œ ì£¼ì… (ê¶Œì¥)
```python
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db
from .auth_service import get_auth_service

# ì˜ì¡´ì„± ì²´ì¸ êµ¬ì„±
def get_auth_service_dep(db: Session = Depends(get_db)):
    """AuthService ì˜ì¡´ì„± í•¨ìˆ˜"""
    return get_auth_service(db)

# ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚¬ìš©
async def sign_up(
    request: SignupRequest,
    db: Session = Depends(get_db),
    auth_service: AuthService = Depends(get_auth_service_dep)
):
    # auth_serviceëŠ” ì´ë¯¸ ì£¼ì…ë¨
    result = auth_service.signup(...)
    # ...
```

#### ë°©ë²• 2: ì˜ì¡´ì„± ì²´ì¸ ì§ì ‘ êµ¬ì„± (ê°„ê²°í•¨)
```python
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db
from .auth_service import AuthService

def get_auth_service_dep(db: Session = Depends(get_db)) -> AuthService:
    """AuthService ì˜ì¡´ì„± í•¨ìˆ˜"""
    return AuthService(db)

async def sign_up(
    request: SignupRequest,
    auth_service: AuthService = Depends(get_auth_service_dep)
):
    # dbë„ í•„ìš”í•˜ë©´ auth_service_depì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë¨
    result = auth_service.signup(...)
    # ...
```

#### ë°©ë²• 3: ì¤‘ì²© ì˜ì¡´ì„± (ë³µì¡í•œ ê²½ìš°)
```python
from typing import Annotated
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db
from .auth_service import AuthService
from .voice_service import VoiceService

# íƒ€ì… ë³„ì¹­ìœ¼ë¡œ ì˜ì¡´ì„± ëª…í™•í™”
DbSession = Annotated[Session, Depends(get_db)]

def get_auth_service_dep(db: DbSession) -> AuthService:
    return AuthService(db)

def get_voice_service_dep(db: DbSession) -> VoiceService:
    return VoiceService(db)

async def endpoint(
    auth_service: AuthService = Depends(get_auth_service_dep),
    voice_service: VoiceService = Depends(get_voice_service_dep)
):
    # ë‘ ì„œë¹„ìŠ¤ ëª¨ë‘ ì£¼ì…ë¨
    # ...
```

### ğŸ“‹ ì˜ì¡´ì„± ì£¼ì… ê·œì¹™

1. **ëª¨ë“  Serviceì™€ RepositoryëŠ” Dependsë¡œ ì£¼ì…ë°›ì•„ì•¼ í•¨**
   - ì—”ë“œí¬ì¸íŠ¸ì—ì„œ `get_xxx_service(db)` ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€
   - ì—”ë“œí¬ì¸íŠ¸ì—ì„œ `get_xxx_repo()` ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€

2. **ì˜ì¡´ì„± í•¨ìˆ˜ ëª…ëª… ê·œì¹™**
   - Service ì˜ì¡´ì„±: `get_{service_name}_dep` (ì˜ˆ: `get_auth_service_dep`)
   - Repository ì˜ì¡´ì„±: `get_{repo_name}_dep` (ì˜ˆ: `get_voice_repo_dep`)
   - íƒ€ì… íŒíŒ… í•„ìˆ˜

3. **ì˜ì¡´ì„± ì²´ì¸ êµ¬ì„±**
   - ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì€ ìµœìƒìœ„ ì˜ì¡´ì„±
   - ServiceëŠ” Sessionì— ì˜ì¡´
   - RepositoryëŠ” Sessionì— ì˜ì¡´
   - Serviceê°€ Repositoryë¥¼ ì‚¬ìš©í•  ê²½ìš°, Service ìƒì„±ìì—ì„œ ì£¼ì…

4. **ì˜ì¡´ì„± í•¨ìˆ˜ ìœ„ì¹˜**
   - ê° Service/Repository íŒŒì¼ì— ì˜ì¡´ì„± í•¨ìˆ˜ë„ í•¨ê»˜ ì •ì˜
   - ë˜ëŠ” ë³„ë„ `dependencies.py` íŒŒì¼ì— ëª¨ìŒ

### ğŸ”„ ê¸°ì¡´ ì½”ë“œ ë¦¬íŒ©í† ë§ ì˜ˆì‹œ

```python
# âŒ ê¸°ì¡´ (ì˜ëª»ëœ ë°©ì‹)
@app.post("/sign-up")
async def sign_up(request: SignupRequest, db: Session = Depends(get_db)):
    auth_service = get_auth_service(db)  # ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”
    result = auth_service.signup(...)
    # ...

# âœ… ë¦¬íŒ©í† ë§ í›„ (ì˜¬ë°”ë¥¸ ë°©ì‹)
def get_auth_service_dep(db: Session = Depends(get_db)) -> AuthService:
    return get_auth_service(db)

@app.post("/sign-up")
async def sign_up(
    request: SignupRequest,
    auth_service: AuthService = Depends(get_auth_service_dep)
):
    result = auth_service.signup(...)
    # ...
```

### ğŸ“ ì˜ì¡´ì„± í•¨ìˆ˜ ì‘ì„± ê°€ì´ë“œ

#### Service ì˜ì¡´ì„± í•¨ìˆ˜ ì˜ˆì‹œ
```python
# app/auth_service.py
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db

class AuthService:
    def __init__(self, db: Session):
        self.db = db
    # ...

def get_auth_service(db: Session) -> AuthService:
    """íŒ©í† ë¦¬ í•¨ìˆ˜"""
    return AuthService(db)

# ì˜ì¡´ì„± í•¨ìˆ˜ ì¶”ê°€
def get_auth_service_dep(db: Session = Depends(get_db)) -> AuthService:
    """FastAPI ì˜ì¡´ì„± ì£¼ì…ìš© í•¨ìˆ˜"""
    return get_auth_service(db)
```

#### ì—¬ëŸ¬ ì˜ì¡´ì„±ì„ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸
```python
async def complex_endpoint(
    db: Session = Depends(get_db),
    auth_service: AuthService = Depends(get_auth_service_dep),
    voice_service: VoiceService = Depends(get_voice_service_dep)
):
    # ëª¨ë“  ì˜ì¡´ì„±ì´ ìë™ìœ¼ë¡œ ì£¼ì…ë¨
    # ...
```

### ğŸ§ª í…ŒìŠ¤íŠ¸ì—ì„œì˜ ì´ì 

ì˜ì¡´ì„± ì£¼ì…ì„ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ì‰¬ì›Œì§:

```python
# í…ŒìŠ¤íŠ¸ì—ì„œ Mock ì£¼ì… ê°€ëŠ¥
def test_endpoint():
    mock_auth_service = Mock(spec=AuthService)
    mock_auth_service.signup.return_value = {"success": True, ...}
    
    # ì˜ì¡´ì„± ì˜¤ë²„ë¼ì´ë“œ
    app.dependency_overrides[get_auth_service_dep] = lambda: mock_auth_service
    
    response = client.post("/sign-up", json={...})
    # ...
```

## FastAPI ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
- ë¼ìš°í„°ë³„ë¡œ `APIRouter` ì‚¬ìš©í•˜ì—¬ ì½”ë“œ ëª¨ë“ˆí™”
- ì—”ë“œí¬ì¸íŠ¸ í•¨ìˆ˜ëŠ” `async def` ì‚¬ìš©
- Response modelì€ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜ (`response_model` íŒŒë¼ë¯¸í„° ì‚¬ìš©)

### ì˜ˆì™¸ ì²˜ë¦¬
- ì»¤ìŠ¤í…€ ì˜ˆì™¸ëŠ” `AppException` ê³„ì¸µ êµ¬ì¡° ì‚¬ìš©
- ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë¡œ ì¼ê´€ëœ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ìœ ì§€
- ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆì™¸ëŠ” `SQLAlchemyError` í•¸ë“¤ëŸ¬ë¡œ ì²˜ë¦¬

### íƒ€ì… íŒíŒ…
- ëª¨ë“  í•¨ìˆ˜ íŒŒë¼ë¯¸í„°ì™€ ë°˜í™˜ê°’ì— íƒ€ì… íŒíŒ… ì‚¬ìš©
- `Optional[Type]` ì‚¬ìš© ì‹œ `None` ì²˜ë¦¬ ëª…í™•íˆ êµ¬í˜„
- DTOëŠ” Pydantic ëª¨ë¸ ì‚¬ìš©

## SQLAlchemy ì„¸ì…˜ ì‚¬ìš© ê·œì¹™

### Repository íŒ¨í„´
- ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ë¡œì§ì€ `repositories/` ë””ë ‰í† ë¦¬ì— ë¶„ë¦¬
- Repository í•¨ìˆ˜ëŠ” `session: Session`ì„ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìŒ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ `services/` ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜

### ì„¸ì…˜ ê´€ë¦¬
- ì„¸ì…˜ì€ ì—”ë“œí¬ì¸íŠ¸ ë ˆë²¨ì—ì„œë§Œ ìƒì„± (`Depends(get_db)`)
- Serviceì™€ RepositoryëŠ” ìƒì„±ìë‚˜ í•¨ìˆ˜ íŒŒë¼ë¯¸í„°ë¡œ ì„¸ì…˜ì„ ë°›ìŒ
- ì„¸ì…˜ì„ ì§ì ‘ ìƒì„±(`SessionLocal()`)í•˜ëŠ” ê²ƒì€ ê¸ˆì§€

### íŠ¸ëœì­ì…˜ ì²˜ë¦¬
- `autocommit=False`ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ëª…ì‹œì  `commit()` í•„ìš”
- ì˜ˆì™¸ ë°œìƒ ì‹œ `rollback()` í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- íŠ¸ëœì­ì…˜ ê²½ê³„ëŠ” ì—”ë“œí¬ì¸íŠ¸ ë ˆë²¨ì—ì„œ ê´€ë¦¬

## ì½”ë“œ ìŠ¤íƒ€ì¼

### Import ìˆœì„œ
1. í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (`os`, `typing` ë“±)
2. ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ (`fastapi`, `sqlalchemy` ë“±)
3. ë¡œì»¬ ëª¨ë“ˆ (`from . import ...`)

### í•¨ìˆ˜ ë„¤ì´ë°
- ì—”ë“œí¬ì¸íŠ¸: `snake_case` (ì˜ˆ: `get_user_info`)
- í´ë˜ìŠ¤: `PascalCase` (ì˜ˆ: `VoiceService`)
- ìƒìˆ˜: `UPPER_SNAKE_CASE` (ì˜ˆ: `DB_HOST`)

### ì£¼ì„ ë° ë¬¸ì„œí™”
- ë³µì¡í•œ ë¡œì§ì€ ì£¼ì„ìœ¼ë¡œ ì„¤ëª…
- í•¨ìˆ˜ docstring ì‚¬ìš© ê¶Œì¥
- ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì£¼ì„ìœ¼ë¡œ ì„¤ëª…

## ë³´ì•ˆ ë° ì„±ëŠ¥

### í™˜ê²½ ë³€ìˆ˜
- ë¯¼ê°í•œ ì •ë³´ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬ (`.env` íŒŒì¼)
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ëŠ” ì ˆëŒ€ í•˜ë“œì½”ë”© ê¸ˆì§€

### Connection Pool
- `pool_pre_ping=True`: ì—°ê²° ìƒíƒœ ìë™ í™•ì¸
- `pool_recycle=3600`: 1ì‹œê°„ë§ˆë‹¤ ì—°ê²° ì¬ìƒì„±ìœ¼ë¡œ stale connection ë°©ì§€

### ë©”ëª¨ë¦¬ ê´€ë¦¬
- ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬ ì‹œ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ ì‚¬ìš©
- ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ë¡œì§ í™œìš© (`memory_monitor.py`)

## ê²€í†  ì²´í¬ë¦¬ìŠ¤íŠ¸

ìƒˆ ì½”ë“œ ì‘ì„± ì‹œ ë‹¤ìŒì„ í™•ì¸:

### ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ `Depends(get_db)`ë¡œ ë°›ì•˜ëŠ”ê°€?
- [ ] `next(get_db())` ê°™ì€ íŒ¨í„´ì´ ì—†ëŠ”ê°€?
- [ ] ì˜ˆì™¸ ë°œìƒ ì‹œ ì„¸ì…˜ì´ ì •ë¦¬ë˜ëŠ”ê°€?

### ì˜ì¡´ì„± ì£¼ì…
- [ ] Serviceë¥¼ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
- [ ] Repositoryë¥¼ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
- [ ] ëª¨ë“  Serviceì™€ Repositoryê°€ `Depends`ë¡œ ì£¼ì…ë˜ëŠ”ê°€?
- [ ] ì˜ì¡´ì„± í•¨ìˆ˜ì˜ íƒ€ì… íŒíŒ…ì´ ëª…í™•í•œê°€?
- [ ] ì˜ì¡´ì„± ì²´ì¸ì´ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±ë˜ì—ˆëŠ”ê°€? (Session â†’ Service/Repository)

### ì½”ë“œ í’ˆì§ˆ
- [ ] íƒ€ì… íŒíŒ…ì´ ëª…í™•í•œê°€?
- [ ] í™˜ê²½ ë³€ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©í–ˆëŠ”ê°€?
- [ ] ì»¤ìŠ¤í…€ ì˜ˆì™¸ë¥¼ ì ì ˆíˆ ì‚¬ìš©í–ˆëŠ”ê°€?

## ë¦¬íŒ©í† ë§ ê°€ì´ë“œ

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬

ê¸°ì¡´ ì½”ë“œì—ì„œ ë‹¤ìŒ íŒ¨í„´ì„ ë°œê²¬í•˜ë©´ ì¦‰ì‹œ ìˆ˜ì •:

```python
# âŒ ë°œê²¬ ì‹œ ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
db = next(get_db())

# âœ… ì˜¬ë°”ë¥¸ í˜•íƒœë¡œ ë³€ê²½
async def function(..., db: Session = Depends(get_db)):
```

### 2. ì˜ì¡´ì„± ì£¼ì… ì ìš©

ê¸°ì¡´ ì½”ë“œì—ì„œ ë‹¤ìŒ íŒ¨í„´ì„ ë°œê²¬í•˜ë©´ ì¦‰ì‹œ ìˆ˜ì •:

```python
# âŒ ë°œê²¬ ì‹œ ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
async def endpoint(db: Session = Depends(get_db)):
    auth_service = get_auth_service(db)  # ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”
    voice_service = get_voice_service(db)  # ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”
    # ...

# âœ… ì˜¬ë°”ë¥¸ í˜•íƒœë¡œ ë³€ê²½
def get_auth_service_dep(db: Session = Depends(get_db)) -> AuthService:
    return get_auth_service(db)

def get_voice_service_dep(db: Session = Depends(get_db)) -> VoiceService:
    return get_voice_service(db)

async def endpoint(
    auth_service: AuthService = Depends(get_auth_service_dep),
    voice_service: VoiceService = Depends(get_voice_service_dep)
):
    # ì˜ì¡´ì„±ì´ ìë™ìœ¼ë¡œ ì£¼ì…ë¨
    # ...
```

### 3. ë¦¬íŒ©í† ë§ ìš°ì„ ìˆœìœ„

1. **ìµœìš°ì„ **: `db = next(get_db())` â†’ `Depends(get_db)` (Connection leak ìœ„í—˜)
2. **ë†’ìŒ**: ì—”ë“œí¬ì¸íŠ¸ ë‚´ `get_xxx_service(db)` ì§ì ‘ í˜¸ì¶œ â†’ ì˜ì¡´ì„± ì£¼ì…
3. **ì¤‘ê°„**: ì—”ë“œí¬ì¸íŠ¸ ë‚´ `get_xxx_repo()` ì§ì ‘ í˜¸ì¶œ â†’ ì˜ì¡´ì„± ì£¼ì…
4. **ë‚®ìŒ**: ì½”ë“œ ìŠ¤íƒ€ì¼ ë° ë¬¸ì„œí™” ê°œì„ 

